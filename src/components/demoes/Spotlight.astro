---
import { Image } from 'astro:assets'
import clownSrc from '@/assets/images/clown.png'
import trumpSrc from '@/assets/images/trump.jpg'

const frameAspectRatio = `${clownSrc.width} / ${clownSrc.height}`
---

<div class="spotlight">
  <p class="lede">
    Cursor-following spotlight reveal using <code>mask-image</code> + <code>radial-gradient</code>,
    with minimal JS only updating CSS variables.
  </p>

  <section
    class="demo"
    id="spotlight-demo"
    data-active="false"
    aria-label="Spotlight hover mask demo"
  >
    <div class="image-stack" style={`aspect-ratio: ${frameAspectRatio};`} aria-hidden="true">
      <Image class="img img--base" src={clownSrc} alt="" loading="eager" />
      <Image class="img img--detail" src={trumpSrc} alt="" loading="lazy" />
    </div>

    <div class="demo-controls">
      <button
        id="spotlight-pane-toggle"
        type="button"
        aria-label="Toggle spotlight controls"
        aria-controls="spotlight-pane-wrap"
        aria-expanded="false"
      >
        ðŸ”§ Controls
      </button>

      <div class="pane-wrap" id="spotlight-pane-wrap" data-open="false">
        <div class="pane" id="spotlight-pane" aria-label="Spotlight controls"></div>
      </div>
    </div>
  </section>
</div>

<style>
  .spotlight {
    --radius: 18px;
    color: var(--text-onbrand);
  }

  .lede {
    color: var(--text-onbrand-muted);
    margin-top: 0;
  }

  .demo {
    --spot-x: 50%;
    --spot-y: 50%;
    --spot-r: 260px;
    --spot-soft: 80px;

    position: relative;
    border-radius: calc(var(--radius) + 8px);
    overflow: hidden;
    box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
    isolation: isolate;
  }

  .image-stack {
    position: relative;
    width: 100%;
  }

  .img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: none;
  }

  .img--detail {
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    -webkit-mask-image: radial-gradient(
      circle 0px at 50% 50%,
      rgba(0, 0, 0, 0) 0px,
      rgba(0, 0, 0, 0) 1px
    );
    mask-image: radial-gradient(
      circle 0px at 50% 50%,
      rgba(0, 0, 0, 0) 0px,
      rgba(0, 0, 0, 0) 1px
    );
  }

  .demo[data-active='true'] .img--detail {
    --edge: clamp(0px, calc(var(--spot-r) - var(--spot-soft)), var(--spot-r));
    -webkit-mask-image: radial-gradient(
      circle var(--spot-r) at var(--spot-x) var(--spot-y),
      rgba(0, 0, 0, 1) 0px,
      rgba(0, 0, 0, 1) var(--edge),
      rgba(0, 0, 0, 0) var(--spot-r)
    );
    mask-image: radial-gradient(
      circle var(--spot-r) at var(--spot-x) var(--spot-y),
      rgba(0, 0, 0, 1) 0px,
      rgba(0, 0, 0, 1) var(--edge),
      rgba(0, 0, 0, 0) var(--spot-r)
    );
  }

  .demo[data-active='false'] .img--detail {
    -webkit-mask-image: radial-gradient(
      circle 0px at 50% 50%,
      rgba(0, 0, 0, 0) 0px,
      rgba(0, 0, 0, 0) 1px
    );
    mask-image: radial-gradient(
      circle 0px at 50% 50%,
      rgba(0, 0, 0, 0) 0px,
      rgba(0, 0, 0, 0) 1px
    );
  }

  .demo-controls {
    position: absolute;
    top: 16px;
    right: 16px;
    z-index: 5;
    display: grid;
    justify-items: end;
    gap: 10px;
  }

  .demo-controls button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }

  .pane-wrap {
    display: none;
  }

  .pane-wrap[data-open='true'] {
    display: block;
  }

  .pane {
    width: min(360px, 100%);
  }

  .pane :global(.tp-rotv) {
    border-radius: 14px;
    border: 1px solid var(--color-border);
    background: var(--color-card);
  }

  @media (prefers-reduced-motion: reduce) {
    .img--detail {
      transition: none;
    }
  }
</style>

<script>
  import { Pane } from 'tweakpane'

  const demo = document.getElementById('spotlight-demo')
  const toggleButton = document.getElementById('spotlight-pane-toggle')
  const paneWrap = document.getElementById('spotlight-pane-wrap')
  const paneContainer = document.getElementById('spotlight-pane')

  if (
    !(demo instanceof HTMLElement) ||
    !(toggleButton instanceof HTMLButtonElement) ||
    !(paneWrap instanceof HTMLElement) ||
    !(paneContainer instanceof HTMLElement)
  ) {
    throw new Error('Missing required elements for spotlight demo')
  }

  const params = {
    size: 260,
    softness: 80,
  }

  const pane = new Pane({
    container: paneContainer,
    title: 'Spotlight',
  })
  pane.addBinding(params, 'size', {
    min: 80,
    max: 520,
    step: 1,
  })
  pane.addBinding(params, 'softness', {
    min: 0,
    max: 220,
    step: 1,
  })

  function setPaneOpen(nextOpen: boolean) {
    paneWrap.dataset.open = nextOpen ? 'true' : 'false'
    toggleButton.setAttribute('aria-expanded', nextOpen ? 'true' : 'false')
  }

  toggleButton.addEventListener('click', () => {
    setPaneOpen(paneWrap.dataset.open !== 'true')
  })

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape') return
    setPaneOpen(false)
  })

  const state = {
    raf: 0,
    x: 0,
    y: 0,
    hasPointer: false,
  }

  function px(n: number) {
    return `${Math.round(n)}px`
  }

  function setVars() {
    demo.style.setProperty('--spot-r', px(params.size))
    demo.style.setProperty('--spot-soft', px(params.softness))
  }

  function updatePointerVars() {
    state.raf = 0
    if (!state.hasPointer) return
    demo.style.setProperty('--spot-x', px(state.x))
    demo.style.setProperty('--spot-y', px(state.y))
  }

  function queueUpdate() {
    if (state.raf) return
    state.raf = requestAnimationFrame(updatePointerVars)
  }

  function setFromEvent(event: PointerEvent) {
    const rect = demo.getBoundingClientRect()
    state.hasPointer = true
    demo.dataset.active = 'true'
    state.x = event.clientX - rect.left
    state.y = event.clientY - rect.top
    queueUpdate()
  }

  demo.addEventListener('pointerenter', (event) => setFromEvent(event))
  demo.addEventListener('pointermove', (event) => setFromEvent(event), {
    passive: true,
  })
  demo.addEventListener('pointerdown', (event) => setFromEvent(event))
  demo.addEventListener('pointerleave', () => {
    state.hasPointer = false
    demo.dataset.active = 'false'
    if (state.raf) cancelAnimationFrame(state.raf)
    state.raf = 0
  })

  pane.on('change', () => setVars())

  setVars()
  demo.dataset.active = 'false'
</script>
